\RequirePackage{mathtools}

\def\place@tag@gather{%
	\iftagsleft@
	\kern-\gdisplaywidth@
	\ifshifttag@
	\PackageWarning{eqnnumwarn}{Equation number (\theequation ) has been displaced}%
	\rlap{\vbox{%
			\normalbaselines
			\boxz@
			\vbox to\lineht@{}%
			\raise@tag
	}}%
	\global\shifttag@false
	\else
	\rlap{\boxz@}%
	\fi
	\else
	\ifdim\totwidth@>\displaywidth
	\dimen@\totwidth@
	\advance\dimen@-\displaywidth
	\kern-\dimen@
	\fi
	\ifshifttag@
	\PackageWarning{eqnnumwarn}{Equation number (\theequation ) has been displaced}%
	\llap{\vtop{%
			\raise@tag
			\normalbaselines
			\setbox\@ne\null
			\dp\@ne\lineht@
			\box\@ne
			\boxz@
	}}%
	\global\shifttag@false
	\else
	\llap{\boxz@}%
	\fi
	\fi
}

\def\place@tag{%
\iftagsleft@
\kern-\tagshift@
\if1\shift@tag\row@\relax
\PackageWarning{eqnnumwarn}{Equation number (\theequation ) has been displaced}%%
\rlap{\vbox{%
\normalbaselines
\boxz@
\vbox to\lineht@{}%
\raise@tag
}}%
\else
\rlap{\boxz@}%
\fi
\kern\displaywidth@
\else
\kern-\tagshift@
\if1\shift@tag\row@\relax
%    \end{macrocode}
%    Added depth to correct vertical spacing of shifted
%    equation tags.---dmj, 1994/12/29
%    \begin{macrocode}
\PackageWarning{eqnnumwarn}{Equation number (\theequation ) has been displaced}%
\llap{\vtop{%
\raise@tag
\normalbaselines
\setbox\@ne\null
\dp\@ne\lineht@
\box\@ne
\boxz@
}}%
\else
\llap{\boxz@}%
\fi
\fi
}

\def\mmeasure@#1{%
	\begingroup
	\measuring@true
	%    \end{macrocode}
	%    We use \cs{begin/endgroup} rather than |{}| in this definition of
	%    \cn{label} because the latter would create an extra (wasteful of
	%    main mem) null box in the current math list. [mjd, 1995/01/17]
	%    \begin{macrocode}
	\def\label##1{%
		\begingroup\measuring@false\label@in@display{##1}\endgroup}%
	\def\math@cr@@@{\cr}%
	\let\shoveleft\@iden \let\shoveright\@iden
	\savecounters@
	\global\row@\z@
	\setbox\@ne\vbox{%
		\global\let\df@tag\@empty
		\halign{%
			\setboxz@h{\@lign$\m@th\displaystyle{}##$}%
			\iftagsleft@
			\ifnum\row@=\@ne
			\global\totwidth@\wdz@
			\global\lineht@\ht\z@
			\fi
			\else
			\global\totwidth@\wdz@
			\global\lineht@\dp\z@
			\fi
			\crcr
			#1%
			\crcr
		}%
	}%
	\ifx\df@tag\@empty\else\global\tag@true\fi
	\if@eqnsw\global\tag@true\fi
	\iftag@
	\setboxz@h{%
		\if@eqnsw
		\stepcounter{equation}%
		\tagform@\theequation
		\else
		\df@tag
		\fi
	}%
	\global\tagwidth@\wdz@
	\dimen@\totwidth@
	\advance\dimen@\tagwidth@
	\advance\dimen@\multlinetaggap
	\iftagsleft@\else
	\if@fleqn
	\advance\dimen@\@mathmargin
	\fi
	\fi
	\ifdim\dimen@>\displaywidth
	\PackageWarning{eqnnumwarn}{Equation number (\theequation ) has been displaced}
	\global\shifttag@true
	\else
	\global\shifttag@false
	\fi
	\fi
	\restorecounters@
	\endgroup
}